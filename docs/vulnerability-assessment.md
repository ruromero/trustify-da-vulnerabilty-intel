# Vulnerability Assessment

The Vulnerability Assessment endpoint provides comprehensive vulnerability intelligence with LLM-powered claim extraction and analysis.

## Endpoint

**POST** `/v1/vulnerability/assessment`

## Overview

The vulnerability assessment process:

1. **Data Retrieval**: Fetches vulnerability data from OSV.dev, deps.dev, and Red Hat CSAF
2. **Document Retrieval**: Automatically retrieves and stores all reference documents
3. **Claim Extraction**: Uses LLM to extract structured security claims from documents
4. **Assessment**: Synthesizes exploitability, impact, and limitations from claims
5. **Confidence Computation**: Calculates overall confidence with rule-based scoring

## Request

```json
{
  "cve": "CVE-2024-12345",
  "package": {
    "purl": "pkg:npm/example@1.2.3",
    "dependency_graph": [],
    "scope": "runtime"
  }
}
```

### Request Fields

- **`cve`** (string, required): CVE identifier (e.g., "CVE-2024-12345")
- **`package`** (object, required): Package identity
  - **`purl`** (string, required): Package URL (PURL format)
  - **`dependency_graph`** (array, optional): Parent dependencies
  - **`scope`** (enum, required): Package scope (`runtime`, `development`, `build`, `test`, `unknown`)

## Response

```json
{
  "assessment": {
    "intel": {
      "cve_identity": {
        "cve": "CVE-2024-12345",
        "description": "Vulnerability description...",
        "aliases": [],
        "cvss_vectors": [...],
        "references": [...],
        "published": "2024-01-15T10:00:00Z",
        "last_modified": "2024-01-20T15:30:00Z"
      },
      "package_metadata": {
        "source_repo": "https://github.com/example/repo",
        "homepage": "https://example.com",
        "issue_tracker": "https://github.com/example/repo/issues",
        "licenses": ["MIT"]
      },
      "package_identity": {
        "purl": "pkg:npm/example@1.2.3",
        "dependency_graph": [],
        "scope": "runtime"
      },
      "affected_versions": [
        {
          "range_type": "semver",
          "introduced": "1.0.0",
          "last_affected": "1.2.2",
          "raw": ">=1.0.0 <1.2.3"
        }
      ],
      "fixed_versions": [
        {
          "range_type": "semver",
          "fixed": "1.2.3",
          "raw": ">=1.2.3"
        }
      ],
      "vendor_remediations": [
        {
          "vendor": "Red Hat",
          "category": "vendor_fix",
          "details": "Fixed in version 1.2.3",
          "url": "https://access.redhat.com/security/...",
          "product_ids": ["example"]
        }
      ],
      "claims": [
        {
          "reason": "identification",
          "certainty": "strong",
          "excerpt": "This vulnerability allows...",
          "evidence": [
            {
              "reference_id": "doc_abc123",
              "excerpt": "Vulnerability description from source",
              "trust_level": "high"
            }
          ],
          "rationale": "Clear identification from authoritative source"
        }
      ],
      "reference_ids": ["doc_abc123", "doc_def456", ...]
    },
    "exploitability": {
      "status": "exploitable",
      "certainty": "strong",
      "conditions": ["Requires network access", "User interaction needed"],
      "notes": "Exploitability confirmed by multiple sources"
    },
    "impact": {
      "severity": "high",
      "confidentiality": "high",
      "integrity": "medium",
      "availability": "low",
      "notes": "Impact assessment based on CVSS and claims"
    },
    "confidence": {
      "level": "high",
      "score": 12.5,
      "reason": "Confidence is high because the vulnerability is confirmed by multiple authoritative sources with strong claims, and exploitability is well-documented."
    },
    "limitations": [
      {
        "reason": "runtime_dependent",
        "description": "Exploitability depends on specific runtime conditions"
      }
    ],
    "generated_at": "2024-01-20T16:00:00Z",
    "retrieved_at": "2024-01-20T15:55:00Z"
  },
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

## Response Fields

### `intel` - Vulnerability Intelligence

Static data retrieved from external sources plus extracted claims:

- **`cve_identity`**: CVE metadata (description, CVSS, references, timestamps)
- **`package_metadata`**: Package information from deps.dev
- **`package_identity`**: Package PURL and scope
- **`affected_versions`**: Version ranges affected by the vulnerability
- **`fixed_versions`**: Version ranges where the vulnerability is fixed
- **`vendor_remediations`**: Vendor-specific remediation information (VEX/CSAF)
- **`claims`**: LLM-extracted security claims from reference documents
- **`reference_ids`**: IDs of all reference documents used (for traceability)

### `exploitability` - Exploitability Assessment

LLM-synthesized assessment:

- **`status`**: `exploitable`, `conditionally_exploitable`, `not_exploitable`, `unknown`
- **`certainty`**: `strong`, `conditional`, `indicative`, `identification_only`
- **`conditions`**: Conditions required for exploitation
- **`notes`**: Additional context

### `impact` - Impact Assessment

LLM-synthesized assessment:

- **`severity`**: `low`, `medium`, `high`, `critical`, `unknown`
- **`confidentiality`**: Impact on confidentiality (`none`, `low`, `medium`, `high`, `critical`)
- **`integrity`**: Impact on integrity
- **`availability`**: Impact on availability
- **`notes`**: Additional context

### `confidence` - Overall Confidence

Rule-based confidence computation:

- **`level`**: `high`, `medium`, `low`
- **`score`**: Numerical score (0-20+)
- **`reason`**: LLM-generated explanation of confidence level

### `limitations` - Assessment Limitations

- **`reason`**: `insufficient_data`, `runtime_dependent`, `environment_specific`, `conflicting_data`
- **`description`**: Explanation of the limitation

### Timestamps

- **`retrieved_at`**: When data was retrieved from external APIs
- **`generated_at`**: When the assessment was generated (after LLM processing)

## Data Persistence & Traceability

### Reference Documents (PostgreSQL)

All reference documents are permanently stored with:

- **Content Hash ID**: SHA256 of (canonical_url + raw_content) for deduplication
- **Retrieval Metadata**: Timestamp, source URL, retriever type
- **Content**: Both raw and normalized (markdown) content
- **Metadata**: Extracted metadata (title, authors, tags, code snippets)

**Audit Trail:**
- Every document includes `retrieved_at` timestamp
- Source URL (`canonical_url`) preserved for verification
- Content hash ensures document integrity

### Cached Claims (Redis)

LLM-extracted claims are cached by `(reference_id + content_hash)` to:
- Avoid redundant LLM calls
- Reduce costs
- Improve performance

Cache TTL: 1 hour (configurable via `DA_AGENT_CACHE_TTL`)

### Traceability Features

1. **Reference IDs**: `reference_ids` array links assessment to all source documents
2. **Claim Evidence**: Each claim includes `reference_id` and `excerpt` from source
3. **Timestamps**: Separate `retrieved_at` (data fetch) and `generated_at` (assessment) for audit
4. **LLM Logging**: All LLM calls logged with model, timing, and token usage

## Claim Extraction Process

1. **Document Retrieval**: Fetches documents from PostgreSQL (or retrieves if missing)
2. **LLM Extraction**: Extracts structured claims using OpenAI API
3. **Filtering**: Removes weak/noise claims (e.g., non-security content from commits)
4. **Synthesis**: Deduplicates and merges similar claims
5. **Caching**: Stores extracted claims in Redis

### Claim Types

- **`identification`**: Vulnerability identification
- **`exploitability`**: Exploitation information
- **`impact`**: Impact assessment
- **`mitigation`**: Mitigation strategies

### Claim Certainty

- **`strong`**: Confirmed, high confidence
- **`conditional`**: True under certain conditions
- **`indicative`**: Suggests but not confirmed
- **`identification_only`**: Only identifies vulnerability

## Confidence Computation

Confidence is computed using a rule-based model:

1. **Evidence Strength**: Claim certainty Ã— trust level
2. **Coverage Bonus**: +1 for each claim category present
3. **Uncertainty Penalties**: Subtracted for limitations and ambiguities
4. **Normalization**: Score mapped to High/Medium/Low
5. **LLM Reason**: Human-readable explanation generated

## Error Handling

- **404**: CVE not found in OSV.dev
- **500**: Internal server error (LLM failure, database error, etc.)

All errors include a `request_id` for traceability.

## Performance Considerations

- **Parallel Processing**: Document retrieval and claim extraction run in parallel
- **Caching**: Vulnerability data, package metadata, and claims are cached
- **On-Demand Retrieval**: Documents fetched from DB only when needed for claim extraction
- **LLM Optimization**: Claims cached per document to avoid re-extraction

## Example Use Cases

1. **Security Scanning**: Generate assessments for all dependencies
2. **Vulnerability Prioritization**: Use confidence scores to prioritize remediation
3. **Compliance Reporting**: Generate audit reports with full traceability
4. **Risk Assessment**: Use exploitability and impact for risk scoring
